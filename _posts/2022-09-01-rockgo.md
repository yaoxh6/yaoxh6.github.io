---
layout:     post
title:      "rockgo实现思路"
subtitle:   ""
date:       2022-09-01 23:36:00
author:     "Yaoxh6"
catalog: true
header-style: text
tags:
  - go
  - rpc
  - ecs
  - 分布式
---

# 前言
最近刚加入了[rockgo](https://github.com/zllangct/rockgo)开源项目,一边阅读源码一边记录。该项目是基于ECS思想,go语言实现的游戏服务端框架。截至今日,master分支实现的功能还不完全基于ECS,并且还有一些要完善。先对master分支现存的代码分析,后续完善代码补充文档。

## 模块
根据example中的SingleNodeWithActor例子分析,该例子比较全面,各个模块均使用到
### conf & launcher
conf作为配置文件,用于指定当前节点是什么角色。具体实现是launcher功能,`	Server = RockGO.DefaultServer()`中的`Server`实际上是`launcherComponent`.
```go
    Server.AddComponentGroup("gate", []ecs.IComponent{g})
    Server.AddComponentGroup("room", []ecs.IComponent{&RoomManagerComponent{}})
    Server.Serve()
```
通过`AddComponentGroup`将组件放在`componentGroup`成员变量中,下面的`Serve`函数名感觉有有点误导,所做的是事情是默认将`NodeComponent`和`ActorProxyComponent`也放在`componentGroup`中。所以`componentGroup`存放的是整个项目所用到的所有的`component`。指定具体某个节点的功能是`AttachGroupsTo`的作用,参数则是作为命令行`SingleNodeWithActor.exe -node node_master`的node参数。
```go
func (this *LauncherComponent) Serve() {
	//添加NodeComponent组件，使对象成为分布式节点
	this.Root().AddComponent(&Cluster.NodeComponent{})

	//添加ActorProxy组件，组织节点间的通信
	this.Root().AddComponent(&Actor.ActorProxyComponent{})

	//添加组件到待选组件列表，默认添加master,child组件
	this.AddComponentGroup("master", []ecs.IComponent{&Cluster.MasterComponent{}})
	this.AddComponentGroup("child", []ecs.IComponent{&Cluster.ChildComponent{}})
	if config.Config.ClusterConfig.IsLocationMode && config.Config.ClusterConfig.Role[0] != "single" {
		this.AddComponentGroup("location", []ecs.IComponent{&Cluster.LocationComponent{}})
	}

	//处理single模式
	if len(config.Config.ClusterConfig.Role) == 0 || config.Config.ClusterConfig.Role[0] == "single" {
		config.Config.ClusterConfig.Role = this.componentGroup.AllGroupsName()
	}

	//添加基础组件组,一般通过组建组的定义决定服务器节点的服务角色
	err := this.componentGroup.AttachGroupsTo(config.Config.ClusterConfig.Role, this.Root())
    ...
}
```
`AttachGroupsTo`会统合普遍情况并且从`componentGroup`选出符合conf的`component`, `attachGroupTo`则是为每一个`componentGroup`创建一个含有该group所有component的Object。所以结果如图是树状结构。
![object](/img/in-post/post-rockgo/object.png)
```go
func (this *ComponentGroups) AttachGroupsTo(groupName []string, target *ecs.Object) error {
    ...
	for _, name := range groupName {
		if g, ok := this.group[name]; ok {
			g.attachGroupTo(target)
		}
        ...
	}
	return nil
}
```

### gate
### rpc
### network
### ecs
### cluster
### actor